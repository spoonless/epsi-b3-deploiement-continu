<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>LXC</title>
	<meta name="author" content="David Gayerie">
	<link href="css/article.css" rel="stylesheet" media="screen">
	<link href="css/print-article.css" rel="stylesheet" media="print">
	<link href="highlight/styles/zenburn.css" rel="stylesheet">

	<script src="highlight/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	<script src="js/toc.js"></script>
</head>
<body>
	<div id="titleBar">
		<a href="index.html" title="Retourner au sommaire"><img src="assets/go-home.png"></a>
 		<a href="https://github.com/spoonless/epsi-b3-deploiement-continu/archive/gh-pages.zip" title="Télécharger tout le cours"><img src="assets/download.png"></a>
		<script>document.write(document.title)</script> - EPSI B3 2016/2017 - <a href="mailto:david.gayerie.epsi@mailoo.org">David Gayerie</a>
		<span class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/fr/80x15.png" /></a></span>
	</div>

	<header></header>
	<article>
		<h1><script>document.write(document.title)</script></h1>
		<section id="toc"></section>

		<p><a href="https://linuxcontainers.org/">LXC (Linux Containers)</a> est une solution de virtualisation basée sur la capacité du noyau Linux à faire fonctionner des environnements isolés.
		Les conteneurs partagent le même noyau mais l'utilisation des processeurs, mémoire vive, système de fichier... est isolée les uns des autres.
		Il s'agit donc d'une méthode de virtualisation <i>légère</i> puisque la machine elle-même n'est pas virtualisée. On parle alors de conteneur plutôt que
		de machine virtuelle.</p>
		<p>LXC va nous permettre de créer rapidement des machines afin de pouvoir les configurer. Il s'agit donc d'un outil particulièrement utile à la
		fois pour le déploiement mais aussi les tests.</p>
		
		<aside class="tip">
			<p>Si vous possédez une distribution récente, vous pouvez installer <a href="https://linuxcontainers.org/lxd/introduction/">LXD</a> qui est l'hyperviseur pour LXC.
			Il offre un service centralisé pour la gestion de conteneurs et une simplification de l'utilisation des lignes de commande.</p>
			<p>Si vous souhaitez utiliser LXD, reportez-vous <a href="lxd.html">au chapitre décrivant l'utilisation conjointe de LXC/LXD</a>. Si vous ne pouvez pas installer LXD ou s'il ne
			fonctionne pas correctement, vous pourrez toujours revenir à ce chapitre.</p>
		</aside>

		<aside class="info">
			<p>Le gestionnaire de conteneurs d'application <a href="https://www.docker.com/">Docker</a> est basé sur LXC.</p>
		</aside>

		<section id="id1">
			<h2>Installation</h2>
			<p>L'installation de LXC se fait à partir du gestionnaire de paquet de votre distribution Linux.
			Pour une distribution basée sur Debian (Ubuntu, Mint...), il suffit de taper en ligne de commande:</p>
			<pre><code class="bash">
sudo apt install lxc
			</code></pre>
		</section>

		<section id="utilisation">
			<h2>Utilisation</h2>
			<p><code>lxc</code> permet de manipuler facilement vos conteneurs. Cette section liste les commandes les plus utiles.</p>
			
			<aside class="warn">
				<p>La commande <code>lxc</code> exige des droits privilégiés d'exécution. Vous devez utiliser la commande <code>sudo</code>
				ou toute commande vous donnant les droits nécessaires.</p>
			</aside>
			
			<p>Pour voir la liste des conteneurs installés, leur état et leurs adresses réseau&nbsp;:</p>
			<pre><code class="bash">
lxc-ls -f
			</code></pre>
			<p>Pour créer un conteneur ;</p>
			<pre><code class="bash">
lxc-create --template download --name &lt;nom du conteneur&gt; -- &lt;paramètres de création du conteneur&gt;
			</code></pre>
			
			<aside class="tip">
				<p>Si vous ne passez pas de paramètres de création à la commande <code>lxc-create</code>, alors vous lancez le mode
				interactif pour sélectionner l'image du système que vous souhaitez installer&nbsp;:</p>
				<pre><code class="bash">
lxc-create --template download --name &lt;nom du conteneur&gt;
				</code></pre>
			</aside>
			<p>Pour créer un conteneur Debian jessie pour une architecture 64 bits&nbsp;:</p>
			<pre><code class="bash">
lxc-create --template download --name &lt;nom du conteneur&gt; -- -d debian -r jessie -a amd64
			</code></pre>
			
			<aside class="warn">
				<p>Si cette commande échoue, cela signifie que votre version de LXC est peut-être trop ancienne et que vous n'avez pas accès
				à l'image de Debian jessie. Dans ce cas, essayez le mode intéractif comme décrit dans le cadre ci-dessus, pour connaître
				la liste des images disponibles.</p>
			</aside>
			<p>Pour démarrer/arrêter un conteneur&nbsp;:</p>
			<pre><code class="bash">
lxc-start -n &lt;nom du conteneur&gt;
lxc-stop -n &lt;nom du conteneur&gt;
			</code></pre>
			<p>Pour obtenir des informations détaillées sur le conteneur&nbsp;:</p>
			<pre><code class="bash">
lxc-info -n &lt;nom du conteneur&gt;
			</code></pre>
			<p>Pour lancer un shell en mode superutilisateur</p>
			<pre><code class="bash">
lxc-attach -n &lt;nom du conteneur&gt; -- /bin/bash
			</code></pre>
			<p>Pour exécuter une commande en mode superutilisateur</p>
			<pre><code class="bash">
lxc-attach -n &lt;nom du conteneur&gt; -- &lt;commande&gt;
			</code></pre>
			<p>Pour supprimer un conteneur</p>
			<pre><code class="bash">
lxc-destroy -n &lt;nom du conteneur&gt;
			</code></pre>
			<aside class="tip">
				<p>Si votre conteneur contient des snapshots, vous devez forcer la suppression des snapshots avec l'option <code>-s</code>&nbsp;</p>
				<pre><code class="bash">
lxc-destroy -s -n &lt;nom du conteneur&gt;
				</code></pre>
			</aside>
			<p>Pour créer un snapshot de l'état d'un conteneur</p>
			<pre><code class="bash">
lxc-snapshot -n &lt;nom du conteneur&gt;
			</code></pre>
			<p>Pour voir liste des snapshots disponible pour un conteneur</p>
			<pre><code class="bash">
lxc-snapshot -n &lt;nom du conteneur&gt; -L
			</code></pre>
			<p>Pour restaurer un snapshot</p>
			<pre><code class="bash">
lxc-snapshot -n &lt;nom du conteneur&gt; -r &lt;nom du snapshot&gt;
			</code></pre>
			<p>Pour copier un conteneur</p>
			<pre><code class="bash">
lxc-copy -n &lt;nom du conteneur&gt; -N &lt;nom du nouveau conteneur&gt;
			</code></pre>
			
			<aside class="top">
				<p>Si vous avez une ancienne version de LXC, vous n'aurez pas accès à <code>lxc-copy</code>.
				Dans ce cas, essayez <code>lxc-clone</code>&nbsp;:</p>
				<pre><code class="bash">
lxc-clone &lt;nom du conteneur&gt; &lt;nom du nouveau conteneur&gt;
				</code></pre>
			</aside>
			
			<p>Pour copier un conteneur à partir d'un snapshot</p>
			<pre><code class="bash">
lxc-snapshot -n &lt;nom du conteneur&gt; -r &lt;nom du snapshot&gt; -N &lt;nom du nouveau conteneur&gt;
			</code></pre>
		</section>
	</article>

	<article class="exercice" id="exercice">
		<h2>Exercice&nbsp;: création d'un conteneur Debian</h2>
		<dl>
			<dt>Objectif</dt>
			<dd>Écrire un script shell qui permet de créer un conteneur Debian jessie.</dd>
		</dl>

		<p>Ce script permet de créer un conteneur Debian à jour avec un compte utilisateur accessible en ssh.</p>
		<pre><code class="bash">
sudo lxc-create --template download --name &lt;nom du conteneur&gt; -- -d debian -r jessie -a amd64
sudo lxc-start -n &lt;nom du conteneur&gt;
sudo lxc-attach -n &lt;nom du conteneur&gt; -- apt update
sudo lxc-attach -n &lt;nom du conteneur&gt; -- apt -y upgrade
sudo lxc-attach -n &lt;nom du conteneur&gt; -- apt -y install openssh-server
sudo lxc-attach -n &lt;nom du conteneur&gt; -- adduser <span class="name variable">$USER</span>
		</code></pre>
		<aside class="tip">
			<p>Le temps de création d'un conteneur peut être assez long notamment à cause des mises à jour nécessaires
			du système. Une astuce consiste à créer un image maître du système dont on fera une copie pour chaque
			nouvelle machine. En effet, copier un conteneur ne prend que quelques secondes.</p>
		</aside>
		
		<figure>
			<figcaption>Exemple de script Bash</figcaption>
<pre><code class="bash">
#!/bin/bash -e

CONTAINER_NAME="$1"

while [ -z "$CONTAINER_NAME" ]
do
  read -p "Donnez le nom du nouveau conteneur: " CONTAINER_NAME
done

if [ $(sudo lxc-ls -1 | grep -c "^$CONTAINER_NAME$") == 1 ]
then
  echo "Un conteneur porte déja ce nom..."
else
  sudo lxc-create --template download --name "$CONTAINER_NAME" -- -d debian -r jessie -a amd64
fi

sudo lxc-start -n "$CONTAINER_NAME"
sleep 5
sudo lxc-attach -n "$CONTAINER_NAME" -- apt update
sleep 5
sudo lxc-attach -n "$CONTAINER_NAME" -- apt -y upgrade
sudo lxc-attach -n "$CONTAINER_NAME" -- apt -y install openssh-server python sudo
sudo lxc-attach -n "$CONTAINER_NAME" -- adduser $USER
sudo lxc-attach -n "$CONTAINER_NAME" -- usermod -a -G sudo $USER

</code></pre>
		</figure>
	</article>

	<footer class="license">
		<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/fr/88x31.png" /></a><br />Cette œuvre est mise à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/">Licence Creative Commons Attribution -  Partage dans les Mêmes Conditions 3.0 France</a>.
	</footer>
</body>
</html>
